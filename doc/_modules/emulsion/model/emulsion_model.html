
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>emulsion.model.emulsion_model &#8212; EMULSION (Epidemiological Multi-Level Simulation framework)</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/STEMAH-favicon.png"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for emulsion.model.emulsion_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: emulsion.model.emulsion_model</span>

<span class="sd">.. moduleauthor:: SÃ©bastien Picault &lt;sebastien.picault@inra.fr&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># [HEADER]</span>


<span class="kn">from</span>   <span class="nn">pathlib</span>                 <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span>   <span class="nn">datetime</span>                <span class="k">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span>   <span class="nn">copy</span>                    <span class="k">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">numpy</span>                   <span class="k">as</span>     <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>         <span class="k">as</span>     <span class="nn">dup</span>

<span class="kn">from</span>   <span class="nn">sympy</span>                   <span class="k">import</span> <span class="n">sympify</span><span class="p">,</span> <span class="n">Symbol</span>

<span class="kn">from</span>   <span class="nn">collections</span>             <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span>   <span class="nn">sortedcontainers</span>        <span class="k">import</span> <span class="n">SortedSet</span><span class="p">,</span> <span class="n">SortedDict</span>
<span class="kn">from</span>   <span class="nn">jinja2</span>                  <span class="k">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">PackageLoader</span>

<span class="kn">import</span> <span class="nn">networkx</span>                <span class="k">as</span>     <span class="nn">nx</span>

<span class="kn">from</span>   <span class="nn">emulsion.tools.state</span>    <span class="k">import</span> <span class="n">StateVarDict</span>
<span class="kn">from</span>   <span class="nn">emulsion.tools.misc</span>     <span class="k">import</span> <span class="n">read_csv_prototypes</span><span class="p">,</span> <span class="n">read_from_file</span><span class="p">,</span> <span class="n">load_class</span>
<span class="kn">from</span>   <span class="nn">emulsion.tools.getters</span>  <span class="k">import</span> <span class="n">create_new_serial</span><span class="p">,</span> <span class="n">create_weighted_random</span><span class="p">,</span>\
    <span class="n">create_successor_getter</span><span class="p">,</span> <span class="n">create_predecessor_getter</span><span class="p">,</span>\
    <span class="n">make_random_prototype_getter</span><span class="p">,</span> <span class="n">make_generator_prototype_getter</span>
<span class="kn">from</span>   <span class="nn">emulsion.tools.calendar</span> <span class="k">import</span> <span class="n">EventCalendar</span>
<span class="kn">from</span>   <span class="nn">emulsion.tools.debug</span>    <span class="k">import</span> <span class="n">debuginfo</span>

<span class="kn">from</span>   <span class="nn">emulsion.model.functions</span>      <span class="k">import</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">,</span> <span class="n">DEFAULT_GROUPING_INFO</span><span class="p">,</span> <span class="n">AGGREG_COMP</span><span class="p">,</span> <span class="n">AGGREG_HYBRID</span><span class="p">,</span> <span class="n">AGGREG_METAPOP</span><span class="p">,</span> <span class="n">AGGREG_IBM</span><span class="p">,</span> <span class="n">make_function</span><span class="p">,</span> <span class="n">make_CSV_function</span><span class="p">,</span> <span class="n">make_when_condition</span><span class="p">,</span> <span class="n">make_statevar_getter</span><span class="p">,</span> <span class="n">make_model_value_getter</span>
<span class="kn">from</span>   <span class="nn">emulsion.model.exceptions</span>     <span class="k">import</span> <span class="n">SemanticException</span>
<span class="kn">from</span>   <span class="nn">emulsion.model.state_machines</span> <span class="k">import</span> <span class="n">StateMachine</span>

<span class="c1">#  ______                 _     _             __  __           _      _</span>
<span class="c1"># |  ____|               | |   (_)           |  \/  |         | |    | |</span>
<span class="c1"># | |__   _ __ ___  _   _| |___ _  ___  _ __ | \  / | ___   __| | ___| |</span>
<span class="c1"># |  __| | &#39;_ ` _ \| | | | / __| |/ _ \| &#39;_ \| |\/| |/ _ \ / _` |/ _ \ |</span>
<span class="c1"># | |____| | | | | | |_| | \__ \ | (_) | | | | |  | | (_) | (_| |  __/ |</span>
<span class="c1"># |______|_| |_| |_|\__,_|_|___/_|\___/|_| |_|_|  |_|\___/ \__,_|\___|_|</span>


<div class="viewcode-block" id="EmulsionModel"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel">[docs]</a><span class="k">class</span> <span class="nc">EmulsionModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class in charge of the description of a multi-level</span>
<span class="sd">    epidemiological model. Such models are composed of several</span>
<span class="sd">    processes which may take place at different</span>
<span class="sd">    organization/observation levels. Some of those processes are</span>
<span class="sd">    reified through a function implemented within an agent, while</span>
<span class="sd">    others are represented by a state machine. The model is also in</span>
<span class="sd">    charge of handling symbolic expressions and pre-computing their</span>
<span class="sd">    values, e.g. concerning parameters, transmission functions,</span>
<span class="sd">    etc.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="EmulsionModel.__init__"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">changed_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instantiate the model either from a configuration file or from a</span>
<span class="sd">        string. Both must contain a YAML-based description of the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename: str</span>
<span class="sd">            the path to the YAML file to read</span>
<span class="sd">        description: str</span>
<span class="sd">            a YAML description of the model</span>
<span class="sd">        input_dir: Path</span>
<span class="sd">            the path to the directory where additional data files can be found if needed (default: &#39;data&#39;)</span>
<span class="sd">        changed_values: dict</span>
<span class="sd">            changes if parameter values, if any, specified by command-line option &#39;-p&#39; or &#39;--param&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span> <span class="o">=</span> <span class="n">input_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">model_description</span> <span class="o">=</span> <span class="n">read_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">description</span>
        <span class="k">if</span> <span class="n">changed_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_parameter_values</span><span class="p">(</span><span class="n">model_description</span><span class="p">,</span> <span class="n">changed_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">model_description</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>

<div class="viewcode-block" id="EmulsionModel.normalize_format"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.normalize_format">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_format</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a YAML representation of the model, reformatted to to print</span>
<span class="sd">        lists and dicts using the flow style (no [], no {}) instead of</span>
<span class="sd">        the block style, especially for syntax checking where rules</span>
<span class="sd">        are defined only for flow style.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.copy"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of object (naif method).</span>
<span class="sd">        TODO: Find a way to avoid recharging compartment class when</span>
<span class="sd">        intentiate a MultiProcessManager class with a old model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_reset_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># namespace for all symbols used in the model</span>
        <span class="c1"># dict string -&gt; sympy symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># namespace for calendar periods in the model</span>
        <span class="c1"># dict string -&gt; sympy symbol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_namespace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># cache for all expressions encountered in the model</span>
        <span class="c1"># dict string -&gt; sympy expression</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># cache for all values encountered in the model</span>
        <span class="c1"># dict string -&gt; value or function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># the original description to parse (dict from YAML document)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># default values for modules used in symbolic computing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;emulsion.tools.functions&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;numpy.random&#39;</span><span class="p">,</span> <span class="s1">&#39;math&#39;</span><span class="p">,</span> <span class="s1">&#39;sympy&#39;</span><span class="p">]</span>
        <span class="c1"># name of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s1">&#39;New Model&#39;</span>
        <span class="c1"># time unit (used to specify parameter values)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;days&#39;</span>
        <span class="c1"># duration of a simulation time step (number of time_units)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># duration of a simulation time step (&#39;true&#39; duration)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_duration</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># origin date for the simulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="c1"># dictionary of calendars (keyed by their name)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calendars</span> <span class="o">=</span> <span class="n">SortedDict</span><span class="p">()</span>
        <span class="c1"># reverse dict event -&gt; calendar name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_events</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of default prototypes associated to levels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_prototypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of aggregate vars by level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># list of the processes involved in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># description of the compartment associated with some of the processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># description of the state machines associated with some of the processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of all &#39;parameters&#39; encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">()</span>
        <span class="c1"># dict of all &#39;statevars&#39; encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">()</span>
        <span class="c1"># # dict of all conditions encountered in the model</span>
        <span class="c1"># self.conditions = {}</span>
        <span class="c1"># dict of all actions encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of actions to run for state initialization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of all distributions encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distributions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of all prototypes encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prototypes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># prototype collections: list of functions providing a prototype_name</span>
        <span class="c1"># for a given collection name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prototype_collection</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of all initial conditions encountered in the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of enumerate types used in special variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># dict of all states existing in state machines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">()</span>
        <span class="c1"># dict of parameters to log when explicitly changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params_to_log</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">()</span>
        <span class="c1"># dict of data-based parameters {level -&gt; {filename -&gt; (key variables, parameter names)}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># set of parameters associated with a level-specific value</span>
        <span class="c1"># CRUCIAL ROLE in get_information mechanisms (subsumes others)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters_by_level</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>




<div class="viewcode-block" id="EmulsionModel.add_init_action"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.add_init_action">[docs]</a>    <span class="k">def</span> <span class="nf">add_init_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an action to be performed when initializing agents for</span>
<span class="sd">        the specified state of the state machine. Mainly used for</span>
<span class="sd">        durations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">machine_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">[</span><span class="n">machine_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">[</span><span class="n">machine_name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">[</span><span class="n">machine_name</span><span class="p">][</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_actions</span><span class="p">[</span><span class="n">machine_name</span><span class="p">][</span><span class="n">state</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_init_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Init the list of all encountered symbols, which have to be</span>
<span class="sd">        either parameters or state variables. The association between</span>
<span class="sd">        the name and the corresponding Symbol is stored in the</span>
<span class="sd">        namespace attribute.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># name space for &#39;regular&#39; symbols (i.e. parameters, statevars)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;statevars&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">param</span><span class="p">:</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="n">keyword</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="EmulsionModel.get_value"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.get_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the value associated with the specified name. If the method</span>
<span class="sd">        is called with a name that is not in the model values, try to</span>
<span class="sd">        parse the expression, to prevent failures when called with a</span>
<span class="sd">        final value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;delta_t&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">sympify</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1">### cases of string parameters ?</span>
                <span class="k">return</span> <span class="n">name</span></div>
                <span class="c1"># result = sympify(name, locals=self._namespace)</span>
                <span class="c1"># import sys</span>
                <span class="c1"># sys.exit(-1)</span>

<div class="viewcode-block" id="EmulsionModel.change_parameter_values"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.change_parameter_values">[docs]</a>    <span class="k">def</span> <span class="nf">change_parameter_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">d_changes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Naive method to change several parameter values at the same time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        description: str</span>
<span class="sd">            the YAML description of the model</span>
<span class="sd">        d_changes: dict</span>
<span class="sd">            the dict of parameters that will be modified (name -&gt; new value)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str:</span>
<span class="sd">            the new YAML description of the model with modified parameter _values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d_changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;delta_t&#39;</span><span class="p">:</span>
                <span class="n">description</span><span class="p">[</span><span class="s1">&#39;time_info&#39;</span><span class="p">][</span><span class="s1">&#39;delta_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c1"># was int(value) previously</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">description</span></div>
        <span class="c1">## TODO: below log_params is DEPRECATED and not used anymore</span>
        <span class="c1"># self.parse(self._description)</span>
        <span class="c1"># self.params_to_log.clear()</span>
        <span class="c1"># if log_params:</span>
        <span class="c1">#     for name in changes:</span>
        <span class="c1">#         value = self.get_value(name) if name != &#39;delta_t&#39;\</span>
        <span class="c1">#                                      else self.delta_t</span>
        <span class="c1">#         self.params_to_log[name] = value</span>

<div class="viewcode-block" id="EmulsionModel.set_value"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.set_value">[docs]</a>    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Naif method to change a parameter&#39;s value.</span>
<span class="sd">        Will be more efficient when treating several parameters at</span>
<span class="sd">        the same time.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.parse"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the EmulsionModel from the specified dictionary</span>
<span class="sd">        (expected to come from a YAML configuration file).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_all</span><span class="p">()</span>
        <span class="c1"># keep an exhaustive description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="c1"># retrieve the name of the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span>
        <span class="c1"># build association between symbols names (all parameter and</span>
        <span class="c1"># statevars names) and true sympy symbols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_namespace</span><span class="p">()</span>
        <span class="c1"># parse data-based information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_input_data</span><span class="p">()</span>
        <span class="c1"># parse time informations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_timeinfo</span><span class="p">()</span>
        <span class="c1"># parse output options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_outputs_options</span><span class="p">()</span>
        <span class="c1">#  rapidly check state machines to build is_state and</span>
        <span class="c1">#  duration_in_state_machine properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_state_machines</span><span class="p">()</span>
        <span class="c1"># parse parameters, state variables and distributions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_statevars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_levels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_distributions</span><span class="p">()</span>
        <span class="c1"># parse processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_processes</span><span class="p">()</span>
        <span class="c1"># parse compartment description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_compartment_desc</span><span class="p">()</span>
        <span class="c1"># parse state machines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_state_machines</span><span class="p">()</span>
        <span class="c1"># parse prototypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_prototypes</span><span class="p">()</span>
        <span class="c1"># parse initial_conditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_initial_conds</span><span class="p">()</span>
        <span class="c1"># parse actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_actions</span><span class="p">()</span>
        <span class="c1"># # calculate expressions from parameters</span>
        <span class="c1"># self.calculate_compound_params()</span>
        <span class="c1"># replace expressions by values or lambdas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="s1">&#39;delta_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="s1">&#39;duration of the simulation time step&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="EmulsionModel.build_outputs_options"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_outputs_options">[docs]</a>    <span class="k">def</span> <span class="nf">build_outputs_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the outputs options of the model.</span>
<span class="sd">        The agents will treat extra variables for outputs (TODO), and</span>
<span class="sd">        the simulation classes will treat period outputs.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        outputs:</span>
<span class="sd">          # level</span>
<span class="sd">          herd:</span>
<span class="sd">            period:1</span>
<span class="sd">          # level</span>
<span class="sd">          metapop:</span>
<span class="sd">            period: 7</span>
<span class="sd">            extra_vars:</span>
<span class="sd">              - step</span>
<span class="sd">              - infection_date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;outputs&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="EmulsionModel.build_timeinfo"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_timeinfo">[docs]</a>    <span class="k">def</span> <span class="nf">build_timeinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the</span>
<span class="sd">        information related to time management, i.e. time unit,</span>
<span class="sd">        duration of a simulation step, origin date, calendars for</span>
<span class="sd">        specific events, etc.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        time_info:</span>
<span class="sd">        time_unit: days</span>
<span class="sd">        delta_t: 7</span>
<span class="sd">        origin: &#39;May 1&#39;</span>
<span class="sd">        calendar:</span>
<span class="sd">          name:</span>
<span class="sd">          period: {days: 52}</span>
<span class="sd">          events:</span>
<span class="sd">            spring: {begin: &#39;April 8&#39;, end: &#39;April 23&#39;}</span>
<span class="sd">            summer: {begin: &#39;July 8&#39;, end: &#39;September 3&#39;}</span>
<span class="sd">            national: {date: &#39;July 14&#39;}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_namespace</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;time_info&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="n">tinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;time_info&#39;</span><span class="p">]</span>
            <span class="c1"># compute effective duration of one time step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;time_unit&#39;</span><span class="p">]</span>
            <span class="c1"># parse expression for delta_t if any and store its value</span>
            <span class="c1"># into the delta_t attribute</span>
            <span class="c1"># self.delta_t = tinfo[&#39;delta_t&#39;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sympify</span><span class="p">(</span><span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;delta_t&#39;</span><span class="p">],</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">))</span>
            <span class="n">timedesc</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_duration</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="n">timedesc</span><span class="p">)</span>
            <span class="c1"># origin date for the simulation</span>
            <span class="k">if</span> <span class="s1">&#39;origin&#39;</span> <span class="ow">in</span> <span class="n">tinfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">origin_date</span> <span class="o">=</span> <span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">])</span>
            <span class="c1"># total duration for the simulation (in time units)</span>
            <span class="k">if</span> <span class="s1">&#39;total_duration&#39;</span> <span class="ow">in</span> <span class="n">tinfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;total_duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;total_duration&#39;</span><span class="p">],</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;stop_condition&#39;</span> <span class="ow">in</span> <span class="n">tinfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;stop_condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;stop_condition&#39;</span><span class="p">],</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_stop</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conditional_stop</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># handle calendars</span>
            <span class="k">if</span> <span class="s1">&#39;calendars&#39;</span> <span class="ow">in</span> <span class="n">tinfo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_calendar</span><span class="p">(</span><span class="n">tinfo</span><span class="p">[</span><span class="s1">&#39;calendars&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="EmulsionModel.build_calendar"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_calendar">[docs]</a>    <span class="k">def</span> <span class="nf">build_calendar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calendar_desc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a representation of calendars.&quot;&quot;&quot;</span>
        <span class="c1"># init name space for &#39;event&#39; symbols (periods of</span>
        <span class="c1"># time) and handle period definitions</span>
        <span class="k">for</span> <span class="n">cal_name</span><span class="p">,</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">calendar_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;events&#39;</span> <span class="ow">in</span> <span class="n">cal</span><span class="p">:</span>
                <span class="n">cal_period</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="n">cal</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="s1">&#39;period&#39;</span> <span class="ow">in</span> <span class="n">cal</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="n">cal</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># register the event name in the events namespace</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_event_namespace</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
                    <span class="c1"># if keyword &quot;date&quot; is used, begin = end</span>
                    <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>
                        <span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]),</span>
                                              <span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">]),</span>
                                              <span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]))</span>
                        <span class="c1"># if begin and end date are specified,</span>
                        <span class="c1"># register events corresponding to &quot;begin_event&quot;</span>
                        <span class="c1"># and &quot;end_event&quot;</span>
                        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin&#39;</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">]:</span>
                            <span class="n">event_limit</span> <span class="o">=</span> <span class="n">keyword</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">event_name</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_event_namespace</span><span class="p">[</span><span class="n">event_limit</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">event_limit</span><span class="p">)</span>
                            <span class="n">events</span><span class="p">[</span><span class="n">event_limit</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="n">keyword</span><span class="p">]),</span>
                                                   <span class="n">dup</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">definition</span><span class="p">[</span><span class="n">keyword</span><span class="p">]))</span>
                    <span class="c1"># register the durations of each event</span>
                    <span class="c1"># compute duration of event</span>
                    <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;=</span> <span class="n">begin</span><span class="p">:</span>
                        <span class="n">dur</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dur</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">cal_period</span>
                    <span class="c1"># compute duration of 1 time unit</span>
                    <span class="n">unit</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                    <span class="n">dur_unit</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="o">**</span><span class="n">unit</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">dur_unit</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                        <span class="n">dur</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># 1h / 1min / 1s ...</span>
                        <span class="n">dur</span> <span class="o">+=</span> <span class="n">dur_unit</span>
                    <span class="c1"># convert duration to time units</span>
                    <span class="n">event_duration</span> <span class="o">=</span> <span class="n">dur</span> <span class="o">/</span> <span class="n">dur_unit</span>
                    <span class="n">duration_param</span> <span class="o">=</span> <span class="s1">&#39;duration_of_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">duration_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">duration_param</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">duration_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">event_duration</span><span class="p">)</span>
                    <span class="c1"># cal_name = cal[&#39;name&#39;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calendars</span><span class="p">[</span><span class="n">cal_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">EventCalendar</span><span class="p">(</span><span class="n">cal_name</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">step_duration</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">origin_date</span><span class="p">,</span>
                                                     <span class="n">cal_period</span><span class="p">,</span>
                                                     <span class="o">**</span><span class="n">events</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendars</span><span class="p">[</span><span class="n">cal_name</span><span class="p">]</span><span class="o">.</span><span class="n">get_events</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_name</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_namespace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">expression</span><span class="p">)]</span> <span class="o">=</span> <span class="n">make_when_condition</span><span class="p">(</span>
                    <span class="n">expression</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmulsionModel.get_calendar_for_event"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.get_calendar_for_event">[docs]</a>    <span class="k">def</span> <span class="nf">get_calendar_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the calendar providing the specified event name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calendars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span></div>

<div class="viewcode-block" id="EmulsionModel.build_parameters"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">build_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the</span>
<span class="sd">        parameters, either with their value, or with the expression to</span>
<span class="sd">        compute them.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        parameters:</span>
<span class="sd">          p:</span>
<span class="sd">            desc: infection probability</span>
<span class="sd">            value: &#39;(1-exp(-E_total)) * (1 - phi*vaccinated)&#39;</span>
<span class="sd">          phi:</span>
<span class="sd">            desc: efficiency of vaccination</span>
<span class="sd">            value: 0.79</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;modules&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;parameters&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                                               <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.build_statevars"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_statevars">[docs]</a>    <span class="k">def</span> <span class="nf">build_statevars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the state</span>
<span class="sd">        variables that agents running this model must have.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        statevars:</span>
<span class="sd">          E_total:</span>
<span class="sd">            desc: total bacteria deposited in the environment</span>
<span class="sd">          vaccinated:</span>
<span class="sd">            desc: 0/1 value describing the vaccination state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">## at this point, data-based level-dependent parameters (if</span>
        <span class="c1">## any) have already been added to the &#39;statevars&#39; section</span>
        <span class="k">if</span> <span class="s1">&#39;statevars&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="EmulsionModel.build_distributions"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_distributions">[docs]</a>    <span class="k">def</span> <span class="nf">build_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the</span>
<span class="sd">        distributions, either with their value, or with the expression</span>
<span class="sd">        to compute them. A distribution is a dictionary of the form</span>
<span class="sd">        {quantity: probability}. It is stored as a list of tuples</span>
<span class="sd">        (quantity, probability) which is more convenient for</span>
<span class="sd">        subsequent processing.</span>

<span class="sd">        TODO: check if completely obsolete ??? deprecated ???</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        distributions:</span>
<span class="sd">          - shedding_dist1:</span>
<span class="sd">              desc: distribution of shedding</span>
<span class="sd">              value:</span>
<span class="sd">                low_shedding: 0.85</span>
<span class="sd">                med_shedding: 0.15</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;distributions&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">list_item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;distributions&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">list_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">distributions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">sympify</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">),</span>
                         <span class="n">sympify</span><span class="p">(</span><span class="n">probability</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">probability</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span></div>

<div class="viewcode-block" id="EmulsionModel.build_initial_conds"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_initial_conds">[docs]</a>    <span class="k">def</span> <span class="nf">build_initial_conds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the initial</span>
<span class="sd">        conditions for each level, either with their value, of with</span>
<span class="sd">        the expression to compute them. An initial condition is a</span>
<span class="sd">        dictionary containing a description of the &#39;content&#39; of the</span>
<span class="sd">        level (i.e. the quantity and initial state of sub-levels),</span>
<span class="sd">        defined by a list of prototypes and corresponding amounts</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        initial_conditions:</span>
<span class="sd">          metapop:</span>
<span class="sd">            - prototype: healthy_herd # defines init_prevalence</span>
<span class="sd">              amount: 100</span>
<span class="sd">            - prototype: infected_herd</span>
<span class="sd">              amount: 1</span>
<span class="sd">          herd:</span>
<span class="sd">            - prototype: [healthy_animal, infected_animal]</span>
<span class="sd">              amount: &#39;init_pop&#39;</span>
<span class="sd">              proba: [&#39;1 - init_prevalence&#39;, &#39;init_prevalence&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;initial_conditions&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;initial_conditions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">list_items</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="n">l_protos</span> <span class="o">=</span> <span class="n">list_items</span><span class="p">[</span><span class="s1">&#39;prototype&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l_protos</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">l_protos</span> <span class="o">=</span> <span class="p">[</span><span class="n">l_protos</span><span class="p">]</span>
                        <span class="n">list_items</span><span class="p">[</span><span class="s1">&#39;prototype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_protos</span>
                    <span class="n">amount</span> <span class="o">=</span> <span class="n">list_items</span><span class="p">[</span><span class="s1">&#39;amount&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;proba&#39;</span> <span class="ow">in</span> <span class="n">list_items</span><span class="p">:</span>
                        <span class="n">l_probas</span> <span class="o">=</span> <span class="n">list_items</span><span class="p">[</span><span class="s1">&#39;proba&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l_probas</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">l_probas</span> <span class="o">=</span> <span class="p">[</span><span class="n">l_probas</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">l_probas</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_protos</span><span class="p">)</span>
                    <span class="n">list_items</span><span class="p">[</span><span class="s1">&#39;proba&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_probas</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_protos</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_probas</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;In initial conditions: inconsistent numbers of prototypes/probabilities</span><span class="se">\n\t</span><span class="s1">prototypes: </span><span class="si">{}</span><span class="s1">, probabilities: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l_protos</span><span class="p">,</span> <span class="n">l_probas</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initial_conditions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">l_protos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">l_probas</span><span class="p">]))</span></div>

<div class="viewcode-block" id="EmulsionModel.build_prototypes"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_prototypes">[docs]</a>    <span class="k">def</span> <span class="nf">build_prototypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the list of</span>
<span class="sd">        prototypes for each level, either with their value, or with</span>
<span class="sd">        the expression to compute them. A prototype is a dictionary of</span>
<span class="sd">        the form {statevar: value}..</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>

<span class="sd">        .. code-block:: yaml</span>

<span class="sd">           prototypes:</span>
<span class="sd">             animals:           # name of a level</span>
<span class="sd">               - newborn:       # prototype name</span>
<span class="sd">                   # description of the prototype</span>
<span class="sd">                   desc: &#39;prototype for new calves&#39;</span>
<span class="sd">                   # list of variables with values</span>
<span class="sd">                   health_state: M</span>
<span class="sd">                   life_state: NP</span>
<span class="sd">                   age: 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;prototypes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">prototypes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;prototypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prototypes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">list_item</span> <span class="ow">in</span> <span class="n">prototypes</span><span class="p">:</span>
                    <span class="c1"># read all prototypes for a given level</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">list_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">prototype</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                        <span class="c1"># read all variables for prototype named &quot;key&quot;</span>
                        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_prototype_line</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">prototype</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                        <span class="c1"># test if an ordered affectation is defined:</span>
                        <span class="c1"># if so, parse the list of variable</span>
                        <span class="c1"># assignation as a list of tuples (name of</span>
                        <span class="c1"># variable, value)</span>
                        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_with&#39;</span><span class="p">,</span> <span class="s1">&#39;end_with&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                                <span class="n">l_items</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">proto_item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">[</span><span class="n">keyword</span><span class="p">]:</span>
                                    <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">proto_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_prototype_line</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                                        <span class="n">l_items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">variable</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
                                <span class="n">prototype</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_items</span>
                        <span class="c1"># test if a collection is defined</span>
                        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                            <span class="c1"># this is not an isolated prototype but a</span>
                            <span class="c1"># collection of prototypes specified in a</span>
                            <span class="c1"># CSV file</span>
                            <span class="c1"># check if any filtering condition on the lines of the CSV file</span>
                            <span class="n">cond</span> <span class="o">=</span> <span class="n">make_CSV_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expand_expression</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="n">include_values</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;include_values&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;include_values&#39;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="p">[]</span>
                            <span class="n">exclude_values</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;exclude_values&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;exclude_values&#39;</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">else</span> <span class="p">[]</span>
                            <span class="c1"># check the selection method that will be used to pick real prototypes in the collection</span>
                            <span class="k">if</span> <span class="s1">&#39;select&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;No selection method provided for prototype collection </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                            <span class="n">method</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span>
                            <span class="n">par_start</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">par_start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">par_end</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">par_end</span> <span class="o">&lt;</span> <span class="n">par_start</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Bad parenthesis in selection method </span><span class="si">{}</span><span class="s1"> for prototype collection </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                                <span class="n">special_column</span> <span class="o">=</span> <span class="n">method</span><span class="p">[(</span><span class="n">par_start</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">par_end</span><span class="p">]</span>
                                <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">par_start</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">special_column</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ordered&#39;</span><span class="p">,</span> <span class="s1">&#39;ordered_cycle&#39;</span><span class="p">,</span> <span class="s1">&#39;random_replace&#39;</span><span class="p">,</span> <span class="s1">&#39;random_noreplace&#39;</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Unknown selection method </span><span class="si">{}</span><span class="s1"> for prototype collection </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                            <span class="n">collection</span> <span class="o">=</span> <span class="n">read_csv_prototypes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]),</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                                             <span class="n">condition</span><span class="o">=</span><span class="n">cond</span><span class="p">,</span> <span class="n">weight_column</span><span class="o">=</span><span class="n">special_column</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include_values</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude_values</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">proto_freq</span><span class="p">,</span> <span class="n">proto_name</span><span class="p">,</span> <span class="n">proto_desc</span> <span class="ow">in</span> <span class="n">collection</span><span class="p">:</span>
                                <span class="n">specific_prototype</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                                <span class="c1"># parse each</span>
                                <span class="k">for</span> <span class="n">spec_var</span><span class="p">,</span> <span class="n">spec_val</span> <span class="ow">in</span> <span class="n">proto_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_prototype_line</span><span class="p">(</span><span class="n">spec_var</span><span class="p">,</span> <span class="n">spec_val</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="n">specific_prototype</span><span class="p">[</span><span class="n">spec_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                                <span class="c1"># correct prototype defined in CSV</span>
                                <span class="c1"># file with information provided in</span>
                                <span class="c1"># YAML model</span>
                                <span class="n">specific_prototype</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">prototype</span><span class="p">)</span>
                                <span class="c1"># add each concrete prototype</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prototypes</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">proto_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">specific_prototype</span>
                            <span class="c1"># register collection named &quot;key&quot;</span>
                            <span class="n">freqs</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">collection</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;random_replace&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prototype_collection</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_random_prototype_getter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prototype_collection</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_generator_prototype_getter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;ordered_cycle&#39;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prototypes</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prototype</span></div>


<div class="viewcode-block" id="EmulsionModel.parse_prototype_line"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.parse_prototype_line">[docs]</a>    <span class="k">def</span> <span class="nf">parse_prototype_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a line in a prototype definition, udpate the model if needed,</span>
<span class="sd">        and return the resulting value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">,</span> <span class="s1">&#39;begin_with&#39;</span><span class="p">,</span> <span class="s1">&#39;end_with&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span> <span class="s1">&#39;include_values&#39;</span><span class="p">,</span> <span class="s1">&#39;exclude_values&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># default case</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;_random_&#39;</span> <span class="o">+</span> <span class="n">variable</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;_default_&#39;</span> <span class="o">+</span> <span class="n">variable</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;next_state&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;_next_state_&#39;</span> <span class="o">+</span> <span class="n">variable</span>
            <span class="c1"># associate to a function that returns the successor of</span>
            <span class="c1"># the state contained in the variable (or a random state</span>
            <span class="c1"># if the variable was not defined)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_successor_getter</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;previous_state&#39;</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;_previous_state_&#39;</span> <span class="o">+</span> <span class="n">variable</span>
            <span class="c1"># associate to a function that returns the predecessor of</span>
            <span class="c1"># the state contained in the variable (or a random state</span>
            <span class="c1"># if the variable was not defined)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_predecessor_getter</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;random(&#39;</span><span class="p">):</span>
            <span class="c1"># result = &#39;_weighted_random_&#39; + variable</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_weighted_random</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;_serial_&#39;</span> <span class="o">+</span> <span class="n">variable</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_new_serial</span><span class="p">(</span><span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_statevar_getter</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_model_value_getter</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_expression</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="c1"># debuginfo(variable, value, result)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="EmulsionModel.get_prototype"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.get_prototype">[docs]</a>    <span class="k">def</span> <span class="nf">get_prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">simu_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a ready-to-use prototype, i.e. a StateVarDict corresponding</span>
<span class="sd">        to the prototype for the specified level and name, where</span>
<span class="sd">        symbols associated to statevariables are already replaced by</span>
<span class="sd">        their value in the model. &#39;Hard-coded&#39; lists are transformed</span>
<span class="sd">        into tuples (to be hashable).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype_collection</span><span class="p">:</span>
            <span class="c1"># use the associated function to retrieve concrete prototype</span>
            <span class="n">prototype_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototype_collection</span><span class="p">[</span><span class="n">name</span><span class="p">](</span><span class="n">simu_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prototype_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="c1">## compute concrete prototype by getting relevant values</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prototypes</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">prototype_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;begin_with&#39;</span><span class="p">,</span> <span class="s1">&#39;end_with&#39;</span><span class="p">]:</span>
                <span class="n">ordered</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">ordered</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ordered</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EmulsionModel.build_input_data"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_input_data">[docs]</a>    <span class="k">def</span> <span class="nf">build_input_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of input data (for now, data-based parameters</span>
<span class="sd">        associated with a level).</span>

<span class="sd">        EXPERIMENTAL FEATURE</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>

<span class="sd">        input_data:</span>
<span class="sd">          databased_parameters:</span>
<span class="sd">            - level: herd</span>
<span class="sd">              file: myparams.csv</span>
<span class="sd">              key_variables: population_id</span>
<span class="sd">              parameters:</span>
<span class="sd">                herd_size:</span>
<span class="sd">                  desc: &#39;initial size of the herd&#39;</span>
<span class="sd">                biosecurity:</span>
<span class="sd">                  desc: &#39;biosecurity level (0-1)&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;input_data&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
            <span class="c1"># parse pre-processing instructions</span>
            <span class="k">if</span> <span class="s1">&#39;preprocessing&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">preprocessing</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;preprocessing&#39;</span><span class="p">]</span>
                <span class="c1">## the management of preprocessing actions is left to Simulation class</span>
            <span class="c1"># debuginfo(self.preprocessing)</span>
            <span class="c1"># parse parameters which are time- and entity-dependent</span>
            <span class="c1"># (functions provided in extension as a CSV file)</span>
            <span class="k">if</span> <span class="s1">&#39;data_based_parameters&#39;</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">:</span>
                <span class="c1"># parse all descriptions (list))</span>
                <span class="k">for</span> <span class="n">csv_desc</span> <span class="ow">in</span> <span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;data_based_parameters&#39;</span><span class="p">]:</span>
                    <span class="c1"># retrieve level, filename, key variables and description of parameters</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="n">csv_desc</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">csv_desc</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
                    <span class="n">key_variables</span> <span class="o">=</span> <span class="n">csv_desc</span><span class="p">[</span><span class="s1">&#39;key_variables&#39;</span><span class="p">]</span>
                    <span class="c1"># if needed transform into list</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_variables</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">key_variables</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_variables</span><span class="p">]</span>
                    <span class="n">param_desc</span> <span class="o">=</span> <span class="n">csv_desc</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span>
                    <span class="n">l_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">param_desc</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">filename</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_variables</span><span class="p">,</span> <span class="n">l_params</span><span class="p">)</span>
                    <span class="c1"># self.parameters_by_level |= set(l_params)</span>
                    <span class="c1"># parse parameter specification</span>
                    <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_spec</span> <span class="ow">in</span> <span class="n">param_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># add parameter name to local namespace</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
                        <span class="c1"># add parameter description to &#39;statevars&#39; section in the _description</span>
                        <span class="k">if</span> <span class="s1">&#39;statevars&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">param_spec</span><span class="p">[</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">filename</span>
                        <span class="p">}</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span><span class="p">:</span>
            <span class="c1"># debuginfo(level)</span>
            <span class="k">for</span> <span class="n">filename</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">databased_parameters</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">key_variables</span><span class="p">,</span> <span class="n">l_params</span> <span class="o">=</span> <span class="n">desc</span></div>
                <span class="c1"># debuginfo(&#39;\t&#39;, filename, &#39;:&#39;, key_variables, &#39;-&gt;&#39;, l_params)</span>

<div class="viewcode-block" id="EmulsionModel.build_levels"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_levels">[docs]</a>    <span class="k">def</span> <span class="nf">build_levels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of different level of simulations.</span>
<span class="sd">        Most of time, there are tree differents levels:</span>
<span class="sd">        individual, herd, metapopulation.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        levels:</span>
<span class="sd">          individuals:</span>
<span class="sd">            super:</span>
<span class="sd">              class: AtomAgent</span>
<span class="sd">            class_name: Cow</span>
<span class="sd">          herd:</span>
<span class="sd">            super:</span>
<span class="sd">              class: MultiProcessManager</span>
<span class="sd">            class_name: QfeverHerd</span>
<span class="sd">          metapop:</span>
<span class="sd">            super:</span>
<span class="sd">              class: MultiProcessManager</span>
<span class="sd">              master_class: StructuredView</span>
<span class="sd">            class_name: QfeverMetaPop</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;levels&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_level</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="c1"># build levels graph</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;contains&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;contains&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">sublevel</span><span class="p">)</span>

        <span class="c1"># check consistency</span>
        <span class="k">if</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_arborescence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debuginfo</span><span class="p">(</span><span class="s1">&#39;Warning, levels do not consitute an arborescence!&#39;</span><span class="p">)</span>
            <span class="n">debuginfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">edges</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

        <span class="c1"># add default information if missing</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;module&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="c1"># try to build module from file</span>
                <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>
                    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parts</span> <span class="o">+</span> <span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">stem</span><span class="p">,))</span>
                    <span class="c1"># if no class name build one (&quot;DefaultLevelnameClass&quot;)</span>
                    <span class="k">if</span> <span class="s1">&#39;class_name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Default</span><span class="si">{}</span><span class="s2">Class&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if level built by aggregation use default level class</span>
                    <span class="k">if</span> <span class="s1">&#39;aggregation_type&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]][</span><span class="s1">&#39;level&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>
                        <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]][</span><span class="s1">&#39;level&#39;</span><span class="p">][</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># try to retrieve upper level if any</span>
                        <span class="n">predecessors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">level</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">predecessors</span><span class="p">:</span>
                            <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="s1">&#39;IBM&#39;</span><span class="p">][</span><span class="s1">&#39;sublevels&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>
                            <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="s1">&#39;IBM&#39;</span><span class="p">][</span><span class="s1">&#39;sublevels&#39;</span><span class="p">][</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c1"># take first information regarding aggregation type</span>
                            <span class="c1">## TODO (research topic on multi-level</span>
                            <span class="c1">## design patterns): hierarchize possibly</span>
                            <span class="c1">## different aggregation types from upper</span>
                            <span class="c1">## levels</span>
                            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="p">:</span>
                                <span class="n">desc_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">pred</span><span class="p">]</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;aggregation_type&#39;</span> <span class="ow">in</span> <span class="n">desc_pred</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">pred_info</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="n">desc_pred</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]]</span>
                                <span class="k">if</span> <span class="s1">&#39;sublevels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pred_info</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_info</span><span class="p">[</span><span class="s1">&#39;sublevels&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>
                                <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pred_info</span><span class="p">[</span><span class="s1">&#39;sublevels&#39;</span><span class="p">][</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s1">&#39;module&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                                <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;default_prototype&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_prototypes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;default_prototype&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;aggregation_type&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;contains&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;No sublevels defined for aggregation type </span><span class="si">{}</span><span class="s1"> at level </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">],</span> <span class="n">level</span><span class="p">))</span>
                <span class="n">default</span> <span class="o">=</span> <span class="n">DEFAULT_LEVEL_INFO</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]]</span>
                <span class="k">if</span> <span class="s1">&#39;super&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;super&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;emulsion.agent&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;sublevels&#39;</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sublevel</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;contains&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;module&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">sublevel</span><span class="p">]</span> <span class="ow">or</span>\
                                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">sublevel</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;emulsion.agent&#39;</span><span class="p">)))</span>\
                               <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;super&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">sublevel</span><span class="p">]):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">sublevel</span><span class="p">][</span><span class="s1">&#39;super&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;sublevels&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;aggregate_vars&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">AGGREG_COMP</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Compartment-based models cannot define aggregate variables&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_vars</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_vars</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">agg_desc</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;aggregate_vars&#39;</span><span class="p">]:</span>
                        <span class="n">newvar</span> <span class="o">=</span> <span class="n">agg_desc</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="n">sourcevar</span> <span class="o">=</span> <span class="n">agg_desc</span><span class="p">[</span><span class="s1">&#39;collect&#39;</span><span class="p">]</span>
                        <span class="n">oper</span> <span class="o">=</span> <span class="n">agg_desc</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;operator&#39;</span> <span class="ow">in</span> <span class="n">agg_desc</span> <span class="k">else</span> <span class="s1">&#39;sum&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_vars</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">newvar</span><span class="p">,</span> <span class="n">sourcevar</span><span class="p">,</span> <span class="n">oper</span><span class="p">))</span></div>

<div class="viewcode-block" id="EmulsionModel.get_agent_class_for_level"><a class="viewcode-back" href="../../../emulsion.model.html#emulsion.model.emulsion_model.EmulsionModel.get_agent_class_for_level">[docs]</a>    <span class="k">def</span> <span class="nf">get_agent_class_for_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_class</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">],</span>
                          <span class="n">class_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;class_name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EmulsionModel.build_processes"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_processes">[docs]</a>    <span class="k">def</span> <span class="nf">build_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and retrieve the list of</span>
<span class="sd">        processes with different level.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        processes:</span>
<span class="sd">          herd:</span>
<span class="sd">            - bacterial_dispersion</span>
<span class="sd">            - culling_process</span>
<span class="sd">            - infection</span>
<span class="sd">          metapop:</span>
<span class="sd">            - inbox_distribution</span>
<span class="sd">            - outbox_distribution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;processes&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;processes&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if any compartment-based aggregation, add the most specific grouping as &#39;MASTER&#39; in the groupings section</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;aggregation_type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">AGGREG_COMP</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;grouping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;grouping&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">level</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">}</span>
                <span class="n">l_sublevels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;contains&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l_sublevels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Compartment-based models cannot aggregate several sublevels: main level </span><span class="si">{}</span><span class="s1"> vs. subevels </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">l_sublevels</span><span class="p">))</span>
                <span class="n">sublevel</span> <span class="o">=</span> <span class="n">l_sublevels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">l_processes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">sublevel</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="p">:</span>
                        <span class="n">l_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;grouping&#39;</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;MASTER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_processes</span>
                <span class="c1">## rewrite list of processes as a list {process_name: grouping}</span>
                <span class="c1">## where grouping is set to None for processes defined in python add-ons</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">sublevel</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                                            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">l_processes</span> <span class="k">else</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="s1">&#39;MASTER&#39;</span><span class="p">}</span>
                                            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">sublevel</span><span class="p">]]</span>
        <span class="c1"># create a dict to associate each state machine to the appropriate level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statemachines_by_level</span> <span class="o">=</span> <span class="p">{</span><span class="n">level</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">l_processes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">l_d_processes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">l_processes</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">l_d_processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">statemachines_by_level</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">process_name</span>
                                                           <span class="k">for</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="n">process</span>
                                                           <span class="k">if</span> <span class="n">process_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l_d_processes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">process</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">statemachines_by_level</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="n">l_d_processes</span></div>

<div class="viewcode-block" id="EmulsionModel.check_state_machines"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.check_state_machines">[docs]</a>    <span class="k">def</span> <span class="nf">check_state_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rapidly inspect the name of state machines and of their states to</span>
<span class="sd">        pre-register automatically built statevars.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;state_machines&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;state_machines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="p">[</span><span class="n">machine_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># to build later</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;duration elapsed (time units) in current </span><span class="si">{}</span><span class="s2"> state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="n">prop_name</span> <span class="o">=</span> <span class="s1">&#39;duration_in_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="c1"># self._description[&#39;statevars&#39;][prop_name] = {&#39;desc&#39;: desc}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">prop_name</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;time step when agent entered current </span><span class="si">{}</span><span class="s2"> state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="n">prop_name</span> <span class="o">=</span> <span class="s1">&#39;_time_entered_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">prop_name</span><span class="p">)</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;time step after which agent is allowed to leave current </span><span class="si">{}</span><span class="s2"> state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="n">prop_name</span> <span class="o">=</span> <span class="s1">&#39;_time_to_exit_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">prop_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">statedict</span> <span class="ow">in</span> <span class="n">description</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">state_name</span> <span class="ow">in</span> <span class="n">statedict</span><span class="p">:</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;Test if </span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">state_name</span><span class="p">)</span>
                        <span class="n">prop_name</span> <span class="o">=</span> <span class="s1">&#39;is_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;desc&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
                        <span class="c1"># self.statevars[prop_name] = desc</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">[</span><span class="n">prop_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">prop_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmulsionModel.build_state_machines"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_state_machines">[docs]</a>    <span class="k">def</span> <span class="nf">build_state_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and build all the</span>
<span class="sd">        required state machines.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;state_machines&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;state_machines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">level_of_machine</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">l_machines</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statemachines_by_level</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1">## ASSUMING THAT A STATE MACHINE IS USED BY ONLY ONE LEVEL !!!</span>
                    <span class="k">if</span> <span class="n">machine_name</span> <span class="ow">in</span> <span class="n">l_machines</span><span class="p">:</span>
                        <span class="n">level_of_machine</span> <span class="o">=</span> <span class="n">level</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">level_of_machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Statemachine </span><span class="si">{}</span><span class="s1"> is associated with no level!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">))</span>
                <span class="c1">## ASSUMING THAT EACH LEVEL HAS ONLY ONE UPPER LEVEL</span>
                <span class="n">upper_level</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">level_of_machine</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aggregation_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">upper_level</span><span class="p">][</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="p">[</span><span class="n">machine_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">aggregation_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.build_compartment_desc"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_compartment_desc">[docs]</a>    <span class="k">def</span> <span class="nf">build_compartment_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inspect the `grouping` part of the model (if any) in order to store</span>
<span class="sd">        the corresponding information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create a graph for grouping nesting</span>
        <span class="n">grouping_graphs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">level_name</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span> <span class="k">for</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="p">}</span>
        <span class="c1"># susbtitution grouping -&gt; most detailed sub-grouping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">substitution_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">level_name</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;grouping&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;grouping&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s1">&#39;aggregation_type&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
                <span class="n">agg_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="s1">&#39;aggregation_type&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">grouping_name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">grouping_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key_variables&#39;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span> <span class="s1">&#39;state_machines&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                    <span class="k">if</span> <span class="n">agg_type</span> <span class="ow">in</span> <span class="n">DEFAULT_GROUPING_INFO</span><span class="p">:</span>

                    <span class="c1"># raise SemanticException(&#39;Unsupported aggregation_type: {}&#39;.format(agg_type))</span>
                        <span class="n">default</span> <span class="o">=</span> <span class="n">DEFAULT_GROUPING_INFO</span><span class="p">[</span><span class="n">agg_type</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;compart_manager&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouping_info</span><span class="p">:</span>
                            <span class="n">grouping_info</span><span class="p">[</span><span class="s1">&#39;compart_manager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;compart_manager&#39;</span><span class="p">]</span> <span class="k">if</span>  <span class="s1">&#39;state_machines&#39;</span> <span class="ow">in</span> <span class="n">grouping_info</span> <span class="k">else</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;fallback_view&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;compart_class&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grouping_info</span><span class="p">:</span>
                            <span class="n">grouping_info</span><span class="p">[</span><span class="s1">&#39;compart_class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span><span class="p">[</span><span class="s1">&#39;compart_class&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">grouping_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grouping_info</span>

                <span class="c1">## identify nesting between groupings</span>
                <span class="k">for</span> <span class="n">grouping_name1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
                    <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">grouping_name1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">grouping_name2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">grouping_name1</span> <span class="o">==</span> <span class="n">grouping_name2</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">key1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">grouping_name1</span><span class="p">][</span><span class="s1">&#39;key_variables&#39;</span><span class="p">]</span>
                        <span class="n">key2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">grouping_name2</span><span class="p">][</span><span class="s1">&#39;key_variables&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">key2</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="n">SemanticException</span><span class="p">(</span><span class="s1">&#39;Two groupings with same variables (not allowed): </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1"> (keep only one of them)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grouping_name1</span><span class="p">,</span> <span class="n">grouping_name2</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">key2</span><span class="p">):</span>
                            <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">grouping_name1</span><span class="p">,</span> <span class="n">grouping_name2</span><span class="p">)</span>
        <span class="c1"># compute substitution in groupings: e.g. if a grouping on var x and a grouping on variables x, y, z exist, the first one must be kept only to define total_X, but state machines must operate only on the grouping based on x, y, z</span>
            <span class="n">leaf_groupings</span> <span class="o">=</span> <span class="p">[</span><span class="n">grouping_name</span> <span class="k">for</span> <span class="n">grouping_name</span> <span class="ow">in</span> <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">grouping_name</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">grouping_name</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">substitution_dict</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">grouping_name</span><span class="p">:</span> <span class="n">substitution</span> <span class="k">for</span> <span class="n">substitution</span> <span class="ow">in</span> <span class="n">leaf_groupings</span> <span class="k">for</span> <span class="n">grouping_name</span> <span class="ow">in</span> <span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">]</span><span class="o">.</span><span class="n">nodes</span><span class="p">()</span> <span class="k">if</span> <span class="n">grouping_name</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">ancestors</span><span class="p">(</span><span class="n">grouping_graphs</span><span class="p">[</span><span class="n">level</span><span class="p">],</span> <span class="n">substitution</span><span class="p">)}</span>
        <span class="c1"># rewrite grouping section to add relevant state machines</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">level</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">process_name</span><span class="p">,</span> <span class="n">grouping</span> <span class="ow">in</span> <span class="n">process</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">grouping</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1">## add current process_name to state_machines in groupings</span>
                        <span class="k">for</span> <span class="n">upper_level</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">level</span><span class="p">):</span>
                            <span class="c1">## if any substitution, do it !</span>
                            <span class="n">grouping_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitution_dict</span><span class="p">[</span><span class="n">upper_level</span><span class="p">][</span><span class="n">grouping</span><span class="p">]</span> <span class="k">if</span> <span class="n">grouping</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitution_dict</span><span class="p">[</span><span class="n">upper_level</span><span class="p">]</span> <span class="k">else</span> <span class="n">grouping</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">[</span><span class="n">upper_level</span><span class="p">][</span><span class="n">grouping_name</span><span class="p">][</span><span class="s1">&#39;state_machines&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="EmulsionModel.get_sublevels"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.get_sublevels">[docs]</a>    <span class="k">def</span> <span class="nf">get_sublevels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of sublevels of the given *level_name*&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">levels_graph</span><span class="o">.</span><span class="n">successors</span><span class="p">(</span><span class="n">level_name</span><span class="p">))</span></div>


    <span class="c1"># def calculate_compound_params(self):</span>
    <span class="c1">#     &quot;&quot;&quot;Inspect all edges of the health states graph and compute</span>
    <span class="c1">#     the actual probabilities associated to expressions.</span>
    <span class="c1">#     ### TODO: check that the ultimate symbols are declared properties.</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     for cond, expr in self.conditions.items():</span>
    <span class="c1">#         self.conditions[cond] = self.expand_expression(expr)</span>


<div class="viewcode-block" id="EmulsionModel.add_expression"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.add_expression">[docs]</a>    <span class="k">def</span> <span class="nf">add_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the specified expression to the dictionary of known</span>
<span class="sd">        expressions.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">expression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>\
           <span class="ow">and</span> <span class="n">expression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statevars</span>\
           <span class="ow">and</span> <span class="n">expression</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span><span class="p">[</span><span class="n">expression</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">expression</span></div>

<div class="viewcode-block" id="EmulsionModel.expand_expression"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.expand_expression">[docs]</a>    <span class="k">def</span> <span class="nf">expand_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform the specified expression so as to replace all</span>
<span class="sd">        parameters by actual values or state variables or</span>
<span class="sd">        attributes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">### WARNING: expand_expressions should iterate over all</span>
        <span class="c1">### expressions at the same time (halting when no change</span>
        <span class="c1">### occurs) instead of iterating over each expression one by</span>
        <span class="c1">### one</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">symbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span>
                 <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="k">while</span> <span class="n">symbs</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span><span class="n">symbs</span><span class="p">)</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace</span><span class="p">)</span>
            <span class="n">symbs</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">free_symbols</span>
                     <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="EmulsionModel.build_actions"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.build_actions">[docs]</a>    <span class="k">def</span> <span class="nf">build_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the description of the model and extract the actions</span>
<span class="sd">        that agents must have.</span>

<span class="sd">        Example of YAML specification:</span>
<span class="sd">        ------------------------------</span>
<span class="sd">        actions:</span>
<span class="sd">          say_hello:</span>
<span class="sd">            desc: action performed when entering the S state</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;actions&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="n">StateVarDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EmulsionModel.compute_values"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.compute_values">[docs]</a>    <span class="k">def</span> <span class="nf">compute_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check parameters and calculated compound parameters, so as</span>
<span class="sd">        to make them computable. In the case of parameters, number</span>
<span class="sd">        values are left unchanged, but strings (representing an</span>
<span class="sd">        expression) are replaced by a function. Regarding calculated</span>
<span class="sd">        compound parameters, expressions corresponding to numbers are</span>
<span class="sd">        converted to float values, while other expressions are</span>
<span class="sd">        replaced by a function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># collect &#39;true&#39; values in the parameters</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_function</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="c1">## DO NOT REALLOCATE EXPRESSIONS ALREADY COMPUTED AS CALLABLE OBJECTS</span>
            <span class="c1">## (introduced to support data-based parameters)</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">]):</span>
                <span class="n">debuginfo</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="s1">&#39;from EXPRESSIONS has value&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">],</span> <span class="s1">&#39;instead of&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_function</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">modules</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="p">)</span>
        <span class="c1"># for (cond, expression) in self.conditions.items():</span>
        <span class="c1">#     value = self.expand_expression(expression)</span>
        <span class="c1">#     if any([str(symb) in self.statevars</span>
        <span class="c1">#             for symb in expression.free_symbols]):</span>
        <span class="c1">#         self._values[cond] = make_function(value, dtype=bool, modules=self.modules)</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         self._values[cond] = bool(value)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">statename</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_values</span><span class="p">[</span><span class="n">statename</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span></div>

<div class="viewcode-block" id="EmulsionModel.get_modifiable_parameters"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.get_modifiable_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">get_modifiable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary containing all true parameters with their</span>
<span class="sd">        value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d_true_params</span> <span class="o">=</span>  <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">p</span><span class="p">))}</span>
        <span class="n">d_true_params</span><span class="p">[</span><span class="s1">&#39;delta_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_t</span>
        <span class="k">return</span> <span class="n">d_true_params</span></div>

<div class="viewcode-block" id="EmulsionModel.describe_parameter"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.describe_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">describe_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the description of the parameter with the specified</span>
<span class="sd">        name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pretty_name = pretty(sympify(name, locals=self._namespace))</span>
        <span class="c1"># param_name = name if pretty_name == name\</span>
        <span class="c1">#              else &quot;{} ({})&quot;.format(pretty_name, name)</span>
        <span class="n">param_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [parameter]:</span><span class="se">\n\t</span><span class="si">{: &lt;72}</span><span class="se">\n\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">param_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.describe_variable"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.describe_variable">[docs]</a>    <span class="k">def</span> <span class="nf">describe_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the description of the statevar with the specified</span>
<span class="sd">        name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pretty_name = pretty(sympify(name, locals=self._namespace))</span>
        <span class="c1"># var_name = name if pretty_name == name\</span>
        <span class="c1">#            else &quot;{} ({})&quot;.format(pretty_name, name)</span>
        <span class="n">var_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> [variable]:</span><span class="se">\n\t</span><span class="si">{: &lt;72}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">var_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;desc&#39;</span><span class="p">],</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.describe_name"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.describe_name">[docs]</a>    <span class="k">def</span> <span class="nf">describe_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the description of the specified name in the model</span>
<span class="sd">        name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe_parameter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">[</span><span class="s1">&#39;statevars&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">describe_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: UNKNOWN NAME&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.write_dot"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.write_dot">[docs]</a>    <span class="k">def</span> <span class="nf">write_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the graph of the each state machine in the</span>
<span class="sd">        specified directer name, according to the dot/graphviz format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">statemachine</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_machines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.dot&#39;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">statemachine</span><span class="o">.</span><span class="n">write_dot</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="EmulsionModel.generate_skeleton"><a class="viewcode-back" href="../../../emulsion_for_modellers.html#emulsion.model.emulsion_model.EmulsionModel.generate_skeleton">[docs]</a>    <span class="k">def</span> <span class="nf">generate_skeleton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Output a code skeleton to help writing specific pieces of code for</span>
<span class="sd">        the specified module to make the model work under Emulsion.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
            <span class="n">loader</span><span class="o">=</span><span class="n">PackageLoader</span><span class="p">(</span><span class="s1">&#39;emulsion&#39;</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">),</span>
            <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jinja2.ext.do&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s1">&#39;specific_code.py&#39;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_module</span><span class="o">=</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div></div>

<span class="n">EmulsionModel</span><span class="o">.</span><span class="n">get_modifiable_parameters</span><span class="o">.</span><span class="n">__USER_METHOD__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Introspection&#39;</span><span class="p">]</span>
<span class="n">EmulsionModel</span><span class="o">.</span><span class="n">describe_parameter</span><span class="o">.</span><span class="n">__USER_METHOD__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Introspection&#39;</span><span class="p">]</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">EMULSION</a></h1>



<p class="blurb">Epidemiological Multi-Level Simulation Framework</p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Information.html">1. Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Install.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Getting_started.html">3. Getting started with EMULSION</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Modelling_principles.html">4. Modelling principles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Modelling_language_basics.html">5. Modelling language (basics)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Modelling_language_advanced.html">6. Modelling language (advanced)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Feature_examples.html">7. Feature examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/Release_notes.html">8. Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pages/License.html">9. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../emulsion_for_modellers.html">10. High-level functions for model designers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../emulsion.html">11. emulsion package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, INRAE and Univ. Lille.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>